<!DOCTYPE html>
<html>
    <head>          
        <script src='sdk/scripts/VSS.SDK.min.js'></script>
        <script src='sdk/scripts/jszip.js'></script>
        <script type='text/javascript'>
            VSS.init({                        
                explicitNotifyLoaded: true,
                usePlatformStyles: true
            });
    
            VSS.require(['TFS/Dashboards/WidgetHelpers', 'TFS/Build/RestClient'], function (WidgetHelpers, BuildRestClient) {
                debugger;
                console.log(WidgetHelpers, BuildRestClient);
                WidgetHelpers.IncludeWidgetStyles();
                VSS.register('npmAuditWidget', function () {
                    var projectId = VSS.getWebContext().project.id;                
                    return {
                        load: function (widgetSettings) {
                            
                            var client = BuildRestClient.getClient();
                            client.getArtifactContentZip(5655,'audit_results', projectId)
                            .then(function (zipArrayBuffer) {
                                JSZip.loadAsync(zipArrayBuffer).then(function (zip) {
                                    console.log(zip);
                                    zip.file('audit_results/audit.json').async('string')
                                    .then((function (auditJson) {
                                        var auditData = JSON.parse(auditJson);
                                        var severities = Object.keys(auditData.advisories)
                                            .reduce(function(prev, key) {
                                                var advisory = auditData.advisories[key];
                                                
                                                prev[advisory.severity] = (prev[advisory.severity] || 0) + 1;

                                                return prev;
                                            }, {});
                                        var widgetArea = $('.widget');
                                        Object.keys(severities)
                                            .map(function(severity) {
                                                widgetArea.append(
                                                    $('div').text(severity + ':' + severities[severity])
                                                );
                                            });
                                        
                                    }));
                                });
                            });
    
                            return WidgetHelpers.WidgetStatusHelper.Success();
                        }
                    }
                });
                VSS.notifyLoadSucceeded();
            });







        </script>              
    </head>
    <body>
        <div class='widget'>
            <h2 class='title'></h2>
        </div>
    </body>
</html>